// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum UserRole {
  admin
  staff
}

enum ArticleStatus {
  draft
  published
  archived
}

enum PageType {
  home
  category
  article
}

// ===========================================
// MODELS
// ===========================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  fullName     String    @map("full_name")
  role         UserRole  @default(staff)
  avatarUrl    String?   @map("avatar_url")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  // Field Baru untuk Reset Password
  passwordResetToken      String?
  passwordResetExpiresAt  DateTime? // Waktu kedaluwarsa token

  // Relations
  articles      Article[]
  refreshTokens RefreshToken[]

  @@map("users")
}

model Category {
  id           String   @id @default(uuid())
  name         String   @unique
  slug         String   @unique
  description  String?
  icon         String?
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  articles Article[]

  @@map("categories")
}

model Article {
  id          String        @id @default(uuid())
  authorId    String        @map("author_id")
  categoryId  String        @map("category_id")
  title       String
  slug        String        @unique
  excerpt     String?
  content     String        @db.Text
  status      ArticleStatus @default(draft)
  publishedAt DateTime?     @map("published_at")
  viewCount   Int           @default(0) @map("view_count")
  helpfulYes  Int           @default(0) @map("helpful_yes")
  helpfulNo   Int           @default(0) @map("helpful_no")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category  Category   @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  pageViews PageView[]

  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@map("articles")
}

model PageView {
  id            String   @id @default(uuid())
  articleId     String?  @map("article_id")
  pagePath      String   @map("page_path")
  pageType      PageType @map("page_type")
  visitorIpHash String?  @map("visitor_ip_hash")
  userAgent     String?  @map("user_agent")
  viewedAt      DateTime @default(now()) @map("viewed_at")

  // Relations
  article Article? @relation(fields: [articleId], references: [id], onDelete: SetNull)

  @@index([articleId])
  @@index([pageType])
  @@index([viewedAt])
  @@map("page_views")
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  tokenHash  String   @map("token_hash")
  expiresAt  DateTime @map("expires_at")
  isRevoked  Boolean  @default(false) @map("is_revoked")
  deviceInfo String?  @map("device_info")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}